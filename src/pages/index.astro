<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Call-Center RAG Assistant</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 900px;
        width: 100%;
        padding: 40px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 2em;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 0.9em;
      }

      .recording-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
      }

      .record-button {
        width: 100%;
        padding: 20px;
        font-size: 1.2em;
        font-weight: bold;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        margin-bottom: 15px;
        position: relative;
      }

      .record-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .record-button:active:not(:disabled) {
        transform: translateY(0);
      }

      .record-button:disabled {
        background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
        cursor: not-allowed;
        opacity: 0.6;
        position: relative;
      }

      .record-button:disabled::after {
        content: " (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)";
        font-size: 0.8em;
        opacity: 0.8;
      }

      .record-button.recording {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .duration-display {
        text-align: center;
        font-size: 1.5em;
        color: #667eea;
        margin: 15px 0;
        font-weight: bold;
      }

      .transcription-section {
        margin-bottom: 30px;
      }

      .transcription-box {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        min-height: 100px;
        font-size: 1.1em;
        line-height: 1.6;
        color: #333;
      }

      .transcription-box.empty {
        color: #999;
        font-style: italic;
      }

      .answer-section {
        background: #e8f5e9;
        border: 2px solid #4caf50;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .answer-section h3 {
        color: #2e7d32;
        margin-bottom: 10px;
      }

      .answer-text {
        color: #1b5e20;
        font-size: 1.1em;
        line-height: 1.6;
      }

      .documents-section {
        margin-top: 20px;
      }

      .document-item {
        background: white;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .document-source {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 5px;
      }

      .document-text {
        color: #333;
        line-height: 1.5;
      }

      .loading {
        text-align: center;
        color: #667eea;
        padding: 20px;
        font-size: 1.1em;
      }

      .error {
        background: #ffebee;
        border: 2px solid #f44336;
        border-radius: 10px;
        padding: 15px;
        color: #c62828;
        margin: 15px 0;
        font-weight: bold;
        animation: shake 0.5s;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      .upload-button-highlight {
        animation: highlight 2s infinite;
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.6) !important;
      }

      @keyframes highlight {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .status {
        text-align: center;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 5px;
        font-size: 0.9em;
      }

      .status.connected {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .status.disconnected {
        background: #ffebee;
        color: #c62828;
      }

      .config-section {
        background: #fff3e0;
        border: 1px solid #ffb74d;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 0.9em;
      }

      .config-section label {
        display: block;
        margin-bottom: 5px;
        color: #e65100;
        font-weight: bold;
      }

      .config-section input,
      .config-section select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ffb74d;
        border-radius: 5px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé§ Call-Center RAG Assistant</h1>
      <p class="subtitle">
        –ó–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
      </p>

      <div class="status" id="status">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>

      <div class="config-section">
        <label>–ò–Ω–¥–µ–∫—Å OpenSearch:</label>
        <input type="text" id="indexName" value="makar_ozon_semantic" />

        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–≤–µ—Ç–∞:</label>
        <input
          type="number"
          id="docCount"
          value="3"
          min="1"
          max="10"
          step="1"
        />
      </div>

      <div class="recording-section">
        <button
          class="record-button"
          id="recordButton"
          onclick="toggleRecording()"
        >
          üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
        </button>
        <div
          id="recordInfo"
          style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #666; display: none;"
        >
          <p style="margin: 5px 0;">
            ‚ö†Ô∏è –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (PyAudio –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
          </p>
          <p style="margin: 5px 0; font-size: 0.85em; color: #999;">
            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª" –Ω–∏–∂–µ
          </p>
        </div>
        <div
          class="duration-display"
          id="durationDisplay"
          style="display: none;"
        >
          00:00
        </div>
        <div
          style="margin-top: 15px; text-align: center; padding-top: 15px; border-top: 2px dashed #ddd;"
        >
          <label
            style="display: block; margin-bottom: 10px; color: #666; font-weight: 500;"
            >üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):</label
          >
          <input
            type="file"
            id="audioFileInput"
            accept="audio/*"
            style="display: none;"
            onchange="handleFileUpload(event)"
          />
          <button
            id="uploadFileButton"
            onclick="document.getElementById('audioFileInput').click()"
            style="padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; transition: all 0.3s; box-shadow: 0 4px 6px rgba(76, 175, 80, 0.3);"
          >
            üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª
          </button>
          <p style="margin-top: 8px; font-size: 0.85em; color: #999;">
            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: WAV, MP3, M4A, OGG
          </p>
        </div>
      </div>

      <div class="transcription-section">
        <h3>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è:</h3>
        <div class="transcription-box empty" id="transcription">
          –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏...
        </div>
      </div>

      <div id="answerSection" style="display: none;">
        <div class="answer-section">
          <h3>üí¨ –û—Ç–≤–µ—Ç —Å–∏—Å—Ç–µ–º—ã:</h3>
          <div class="answer-text" id="answer"></div>
        </div>

        <div
          class="documents-section"
          id="documentsSection"
          style="display: none;"
        >
          <h3>üìö –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:</h3>
          <div id="documents"></div>
        </div>
      </div>

      <div id="errorMessage" style="display: none;"></div>
      <div id="loading" class="loading" style="display: none;">
        –û–±—Ä–∞–±–æ—Ç–∫–∞...
      </div>
    </div>

    <script>
      // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
      const AUDIO_SERVICE_URL = "https://callcenter.thoughtspile.tech/audio";
      const OPENSEARCH_SERVICE_URL = "https://callcenter.thoughtspile.tech";

      let isRecording = false;
      let recordingInterval = null;
      let recordingDuration = 0;

      // Browser recording (WebAudio -> WAV)
      let mediaStream = null;
      let audioContext = null;
      let scriptProcessor = null;
      let audioChunks = [];
      const targetSampleRate = 16000;
      // –ê–≤—Ç–æ-—Å—Ç–æ–ø –ø–æ —Ç–∏—à–∏–Ω–µ
      const SILENCE_THRESHOLD = 0.015; // –ø–æ—Ä–æ–≥ RMS
      const AUTO_SILENCE_MS = 1000; // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–∏—à–∏–Ω—ã –¥–ª—è –∞–≤—Ç–æ-—Å—Ç–æ–ø–∞
      let silenceAccumMs = 0;
      let autoStopping = false;
      const FALLBACK_RECORD_SECONDS = 10; // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ /record –≤ —Å–ª—É—á–∞–µ —Ñ–æ–ª–±–µ–∫–∞

      function resetRecorderState() {
        audioChunks = [];
        silenceAccumMs = 0;
        autoStopping = false;
        if (scriptProcessor) {
          scriptProcessor.disconnect();
          scriptProcessor = null;
        }
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        if (mediaStream) {
          mediaStream.getTracks().forEach((t) => t.stop());
          mediaStream = null;
        }
      }

      async function startBrowserRecording() {
        resetRecorderState();
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        audioContext = new AudioContext({ sampleRate: targetSampleRate });
        const source = audioContext.createMediaStreamSource(mediaStream);
        scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
        scriptProcessor.onaudioprocess = (event) => {
          const input = event.inputBuffer.getChannelData(0);
          audioChunks.push(new Float32Array(input));

          // –ê–≤—Ç–æ-—Å—Ç–æ–ø –ø–æ —Ç–∏—à–∏–Ω–µ: —Å—á–∏—Ç–∞–µ–º RMS –∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º —Ç–∏—à–∏–Ω—É
          let sum = 0;
          for (let i = 0; i < input.length; i++) {
            const s = input[i];
            sum += s * s;
          }
          const rms = Math.sqrt(sum / input.length);
          const chunkMs = (input.length / audioContext.sampleRate) * 1000;
          if (rms < SILENCE_THRESHOLD) {
            silenceAccumMs += chunkMs;
            if (
              !autoStopping &&
              silenceAccumMs >= AUTO_SILENCE_MS &&
              isRecording
            ) {
              autoStopping = true;
              stopRecording(true);
            }
          } else {
            silenceAccumMs = 0;
          }
        };
        source.connect(scriptProcessor);
        scriptProcessor.connect(audioContext.destination);
      }

      function encodeWAV(float32Data, sampleRate) {
        // Convert Float32 [-1,1] to 16-bit PCM and build WAV header
        const buffer = new ArrayBuffer(44 + float32Data.length * 2);
        const view = new DataView(buffer);
        const writeString = (offset, str) => {
          for (let i = 0; i < str.length; i++)
            view.setUint8(offset + i, str.charCodeAt(i));
        };
        writeString(0, "RIFF");
        view.setUint32(4, 36 + float32Data.length * 2, true);
        writeString(8, "WAVE");
        writeString(12, "fmt ");
        view.setUint32(16, 16, true); // PCM chunk size
        view.setUint16(20, 1, true); // format
        view.setUint16(22, 1, true); // channels
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true); // byte rate
        view.setUint16(32, 2, true); // block align
        view.setUint16(34, 16, true); // bits per sample
        writeString(36, "data");
        view.setUint32(40, float32Data.length * 2, true);
        let offset = 44;
        for (let i = 0; i < float32Data.length; i++, offset += 2) {
          const s = Math.max(-1, Math.min(1, float32Data[i]));
          view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
        }
        return new Blob([buffer], { type: "audio/wav" });
      }

      async function stopBrowserRecordingAndGetBlob() {
        if (!audioChunks.length) {
          resetRecorderState();
          throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞");
        }
        // Merge Float32 chunks
        const totalSamples = audioChunks.reduce(
          (acc, arr) => acc + arr.length,
          0
        );
        const merged = new Float32Array(totalSamples);
        let offset = 0;
        for (const chunk of audioChunks) {
          merged.set(chunk, offset);
          offset += chunk.length;
        }
        const blob = encodeWAV(merged, targetSampleRate);
        resetRecorderState();
        return blob;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      async function checkConnection() {
        try {
          const audioStatus = await fetch(`${AUDIO_SERVICE_URL}/health`, {
            method: "GET",
            mode: "cors",
            headers: {
              Accept: "application/json",
            },
          });

          if (audioStatus.ok) {
            const audioData = await audioStatus.json();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å PyAudio
            const pyaudioAvailable = audioData.pyaudio_available || false;
            const recordButton = document.getElementById("recordButton");

            if (!pyaudioAvailable) {
              recordButton.disabled = true;
              recordButton.style.opacity = "1";
              recordButton.style.cursor = "not-allowed";
              recordButton.title =
                "–ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞.";
              document.getElementById("recordInfo").style.display = "block";
              document.getElementById("status").textContent =
                "‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã (–∑–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞)";
              document.getElementById("status").className = "status connected";
            } else {
              recordButton.disabled = false;
              recordButton.style.opacity = "1";
              recordButton.style.cursor = "pointer";
              recordButton.title = "";
              document.getElementById("recordInfo").style.display = "none";
              document.getElementById("status").textContent =
                "‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã";
              document.getElementById("status").className = "status connected";
            }

            return true;
          } else {
            const audioText = await audioStatus.text();
            const opensearchText = await opensearchStatus.text();
            console.error("Audio status:", audioStatus.status, audioText);
            console.error(
              "OpenSearch status:",
              opensearchStatus.status,
              opensearchText
            );
            throw new Error(
              `Services not available: Audio=${audioStatus.status}, OpenSearch=${opensearchStatus.status}`
            );
          }
        } catch (error) {
          console.error("Connection check error:", error);
          document.getElementById("status").textContent =
            `‚ùå –°–µ—Ä–≤–∏—Å—ã –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã: ${error.message}`;
          document.getElementById("status").className = "status disconnected";
          return false;
        }
      }

      // –ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ
      async function toggleRecording() {
        const recordButton = document.getElementById("recordButton");
        if (recordButton.disabled) {
          showError(
            "–ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞."
          );
          return;
        }

        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      }

      async function startRecording() {
        isRecording = true;
        recordingDuration = 0;
        const button = document.getElementById("recordButton");
        const durationDisplay = document.getElementById("durationDisplay");

        button.textContent = "‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å";
        button.classList.add("recording");
        durationDisplay.style.display = "block";
        durationDisplay.textContent = "00:00";

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
        recordingInterval = setInterval(() => {
          recordingDuration++;
          const minutes = Math.floor(recordingDuration / 60);
          const seconds = recordingDuration % 60;
          durationDisplay.textContent = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
        }, 1000);

        // –°—Ç–∞—Ä—Ç –±—Ä–∞—É–∑–µ—Ä–Ω–æ–π –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
        try {
          await startBrowserRecording();
        } catch (e) {
          console.warn(
            "Browser recording failed, fallback to server record:",
            e
          );
        }
      }

      async function stopRecording(autoTriggered = false) {
        isRecording = false;
        const button = document.getElementById("recordButton");
        const durationDisplay = document.getElementById("durationDisplay");

        button.textContent = "üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å";
        button.classList.remove("recording");
        durationDisplay.style.display = "none";

        if (recordingInterval) {
          clearInterval(recordingInterval);
          recordingInterval = null;
        }

        document.getElementById("loading").style.display = "block";
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("transcription").textContent =
          "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...";
        document.getElementById("transcription").classList.add("empty");

        try {
          let transcription = null;

          // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî —à–ª—ë–º —Ñ–∞–π–ª
          if (audioChunks.length) {
            const blob = await stopBrowserRecordingAndGetBlob();
            const formData = new FormData();
            formData.append("file", blob, "recording.wav");
            const resp = await fetch(`${AUDIO_SERVICE_URL}/transcribe`, {
              method: "POST",
              body: formData,
            });
            if (!resp.ok) {
              const errorText = await resp.text();
              throw new Error(
                `Audio service error: ${resp.statusText} - ${errorText}`
              );
            }
            const data = await resp.json();
            transcription = data.transcription;
          } else {
            // –§–æ–ª–ª–±–µ–∫: —Å–µ—Ä–≤–µ—Ä —Å–∞–º –ø–∏—à–µ—Ç —á–µ—Ä–µ–∑ PyAudio
            const recordResponse = await fetch(`${AUDIO_SERVICE_URL}/record`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                duration_seconds: FALLBACK_RECORD_SECONDS,
                sample_rate: 16000,
              }),
            });
            if (!recordResponse.ok) {
              const errorText = await recordResponse.text();
              throw new Error(
                `Audio service error: ${recordResponse.statusText} - ${errorText}`
              );
            }
            const recordData = await recordResponse.json();
            transcription = recordData.transcription;
          }

          document.getElementById("transcription").textContent =
            transcription || "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞";
          document.getElementById("transcription").classList.remove("empty");

          if (!transcription) {
            throw new Error("–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –ø—É—Å—Ç–∞");
          }

          await sendToRAG(transcription);
        } catch (error) {
          console.error("Error:", error);
          showError(`–û—à–∏–±–∫–∞: ${error.message}`);
        } finally {
          resetRecorderState();
          document.getElementById("loading").style.display = "none";
        }
      }

      async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        document.getElementById("loading").style.display = "block";
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("transcription").textContent =
          "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞...";
        document.getElementById("transcription").classList.add("empty");

        try {
          const formData = new FormData();
          formData.append("file", file);

          const transcribeResponse = await fetch(
            `${AUDIO_SERVICE_URL}/transcribe`,
            {
              method: "POST",
              body: formData,
            }
          );

          if (!transcribeResponse.ok) {
            throw new Error(
              `–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏: ${transcribeResponse.statusText}`
            );
          }

          const transcribeData = await transcribeResponse.json();
          const transcription = transcribeData.transcription;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
          document.getElementById("transcription").textContent =
            transcription || "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞";
          document.getElementById("transcription").classList.remove("empty");

          if (!transcription) {
            throw new Error("–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –ø—É—Å—Ç–∞");
          }

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ RAG
          await sendToRAG(transcription);
        } catch (error) {
          console.error("Error:", error);
          showError(`–û—à–∏–±–∫–∞: ${error.message}`);
        } finally {
          document.getElementById("loading").style.display = "none";
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
          event.target.value = "";
        }
      }

      async function sendToRAG(transcription) {
        try {
          const indexName =
            document.getElementById("indexName").value || "makar_ozon_semantic";
          const docCount =
            parseInt(document.getElementById("docCount").value) || 3;

          const ragResponse = await fetch(
            `${OPENSEARCH_SERVICE_URL}/rag/answer`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                query: transcription,
                index_name: indexName,
                size: docCount,
                use_hyde: true,
                use_colbert: true,
                max_tokens: 800,
              }),
            }
          );

          if (!ragResponse.ok) {
            throw new Error(
              `OpenSearch RAG service error: ${ragResponse.statusText}`
            );
          }

          const ragData = await ragResponse.json();

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
          document.getElementById("answer").textContent =
            ragData.answer || "–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω";
          document.getElementById("answerSection").style.display = "block";

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
          if (ragData.documents && ragData.documents.length > 0) {
            const documentsDiv = document.getElementById("documents");
            documentsDiv.innerHTML = "";

            ragData.documents.forEach((doc, index) => {
              const docDiv = document.createElement("div");
              docDiv.className = "document-item";
              docDiv.innerHTML = `
                            <div class="document-source">üìÑ ${doc.source || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫"} (Score: ${doc._score ? doc._score.toFixed(3) : "N/A"})</div>
                            <div class="document-text">${doc.text || ""}</div>
                        `;
              documentsDiv.appendChild(docDiv);
            });

            document.getElementById("documentsSection").style.display = "block";
          } else {
            document.getElementById("documentsSection").style.display = "none";
          }
        } catch (error) {
          console.error("RAG Error:", error);
          showError(`–û—à–∏–±–∫–∞ RAG: ${error.message}`);
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.className = "error";
        errorDiv.style.display = "block";

        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –∑–∞–ø–∏—Å—å—é, –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
        if (
          message.includes("–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞") ||
          message.includes("PyAudio")
        ) {
          const uploadButton = document.querySelector(
            'button[onclick*="audioFileInput"]'
          );
          if (uploadButton) {
            uploadButton.classList.add("upload-button-highlight");
            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
              uploadButton.classList.remove("upload-button-highlight");
            }, 5000);
          }
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.addEventListener("load", () => {
        console.log("Page loaded, checking connections...");
        console.log("Audio Service URL:", AUDIO_SERVICE_URL);
        console.log("OpenSearch Service URL:", OPENSEARCH_SERVICE_URL);
        checkConnection();
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(checkConnection, 10000);
      });

      // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
      console.log("Script loaded");
    </script>
  </body>
</html>
